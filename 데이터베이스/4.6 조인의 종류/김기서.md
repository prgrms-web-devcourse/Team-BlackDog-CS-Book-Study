# 4.6 조인의 종류

- 조인이란 두 개 이상의 테이블을 묶어서 하나의 결과물을 만드는 것을 말한다.
- MongoDB는 lookup이라는 쿼리로 지원하는데 관계형 데이터베이스보다 성능이 떨어지므로 되도록 사용하지 말아야 한다.
- 따라서 조인하는 작업이 많다면 RDB를 사용하자.

### 내부 조인(inner join)

- 왼쪽, 오른쪽 테이블 두 행이 모두 일치하는 행이 있는 부분만 표기한다.

⇒ 두 테이블 간의 교집합을 나타낸다.

### 왼쪽 조인(left join)

- 테이블 B의 일치하는 부분의 레코드와 함께 테이블 A를 기준으로 완전한 레코드 집합을 생성한다.
- 테이블 B에 일치하는 항목이 없으면 해당 값은 null이 된다.

### 오른쪽 조인(right join)

- 테이블 A에서 일치하는 부분의 레코드와 함께 테이블 B를 기준으로 완전한 레코드 집합을 생성한다.
- 테이블 A에 일치하는 항목이 없으면 해당 값은 null이 된다.

### 합집합 조인(union join)

- 양쪽 테이블에서 일치하는 레코드와 함께 테이블 A와 테이블 B의 모든 레코드 집합을 생성한다.
- 일치하는 항목이 없으면 누락된 쪽에 null 값이 포함되어 출력된다.

# 4.7 조인의 원리

### 중첩 루프 조인(Nested Loop Join)

- 중첩 for문과 같은 원리로 조건에 맞는 조인을 하는 방법이다.
- 랜덤 접근에 대한 비용이 증가하므로 대용량 테이블에서는 사용할 수 없다.
- 드라이빙 테이블로 한 테이블을 선정하고 이 테이블로부터 where절에 정의된 검색 조건을 만족하는 데이터들을 걸러낸 후, 이 값을 가지고 조인 대상 테이블을 반복적으로 검색하면서 조인 조건을 만족하는 최종 결과값을 얻어낸다.

### 정렬 병합 조인

- 각각 테이블을 조인할 필드를 기준으로 정렬을 하고, 정렬 이후에 조인 작업을 수행하는 조인
- 조인할 때 사용할 적절한 인덱스가 없거나 대용량의 테이블을 조인하고 조인 조건으로 `>` `<` 등 범위 비교 연산자가 있을 때 사용한다.

### 해시 조인

- 해시 테이블을 기반으로 조인하는 방법
- `MySQL 8.0.18` 버전부터 지원되는 조인
- 네스티드 루프 조인과 처리 성능 비교


- 같은 시점에 시작했지만 `해시 조인`이 먼저 종료되었다.
- 해시 조인은 첫 번째 레코드를 찾는 작업이 오래 걸리지만, 최종 레코드까지 금방 찾는다.
- 네스티드 루프 조인은 최종 레코드까지 시간이 오래 걸리지만 첫 번째 레코드를 찾는 것은 상대적으로 빠르다.

- 즉, 해시 조인 쿼리는 **최고 스루풋 전략**에 적합하며, 네스티드 루프 조인은 **최고 응답 속도 전략**에 적합하다.
    - 일반적인 **웹 서비스**는 **응답 속도**가 더 중요하며, 분석과 같은 서비스는 전체 스루풋이 중요하다.
    - MySQL는 데이터 분석 용도보다 범용 RDBMS로 사용된다 → 응답 속도에 집중해서 최적화 하고있다.
        - 따라서 MySQL 서버는 특수 상황에서만 해시 조인 알고리즘을 사용하도록 설계되어 있다.
        - 해시 조인이 빠르다고 옵티마이저에 힌트를 줘서 강제로 해시 조인을 유도하는 것은 바람직하지 않다.

- 해시 조인은 `**빌드 단계**`와 `**프로브 단계**` 로 나뉘어 처리된다.
    - `빌드 단계`: 조인 대상 테이블 중 `레코드 건수가 적어`서 해시 테이블로 만들기 용이한 테이블을 골라 메모리에 해시 테이블을 생성한다. → 이를 `빌드 테이블`이라고 한다.
    - `프로브 단계`: 나머지 테이블의 레코드를 읽어 해시 테이블의 일치하는 레코드를 찾는 과정 → 이때 읽는 나머지 테이블을 `프로프 테이블` 이라고 한다.